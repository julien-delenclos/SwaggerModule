{"version":3,"sources":["src/index.js"],"names":["SwaggerModule","config","info","basePath","routesDirectory","visibility","access","options","Object","assign","swaggerDefinition","apis","path","resolve","swaggerSpec","filterSpec","key","swaggerSpecDefinitions","keys","paths","forEach","element","some","p","includes","results","searchProperty","r","push","definitions","getElements","obj","search","depth","prototype","hasOwnProperty","call","spec","elements","map","d","split","length","refs","app","all","req","res","next","products","undefined","send","swaggerSpecAdmin","filterAccess","use","swaggerUi","serve","setup","filterVisibility","module","exports"],"mappings":"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","sourcesContent":["import swaggerUi from 'swagger-ui-express'\r\nimport swaggerJSDoc from 'swagger-jsdoc'\r\nimport path from 'path'\r\n\r\nclass SwaggerModule {\r\n  config = {\r\n    info: 'Title',\r\n    basePath: '/',\r\n    routesDirectory: '',\r\n    visibility: [],\r\n    access: []\r\n  }\r\n\r\n  options = {}\r\n\r\n  constructor(config) {\r\n    Object.assign(this.config, config)\r\n    this.options = {\r\n      swaggerDefinition: {\r\n        info: this.config.info,\r\n        basePath: this.config.basePath\r\n      },\r\n      apis: [path.resolve(this.config.routesDirectory) + '/*.js', '../../*.js.LICENSE']\r\n    }\r\n  }\r\n\r\n  filterVisibility(swaggerSpec) {\r\n    return this.filterSpec(swaggerSpec, 'visibility')\r\n  }\r\n\r\n  filterAccess(swaggerSpec) {\r\n    return this.filterSpec(swaggerSpec, 'access')\r\n  }\r\n\r\n  filterSpec(swaggerSpec, key) {\r\n    let swaggerSpecDefinitions = []\r\n    Object.keys(swaggerSpec.paths).forEach((element) => {\r\n      if(swaggerSpec.paths[element][`x-${key}`] && !this.config[key].some(p => swaggerSpec.paths[element][`x-${key}`].includes(p))){\r\n        delete swaggerSpec.paths[element]\r\n      }\r\n      else {\r\n        let results = []\r\n        this.searchProperty(swaggerSpec.paths[element], '$ref', results)\r\n        results.forEach(r => swaggerSpecDefinitions.push(r))\r\n      }\r\n    })\r\n\r\n    swaggerSpec.definitions = this.getElements(swaggerSpec.definitions, swaggerSpecDefinitions)\r\n\r\n    return swaggerSpec\r\n  }\r\n\r\n  searchProperty(obj, search, results, depth = 0) {\r\n    for(var p in obj){\r\n      if (Object.prototype.hasOwnProperty.call(obj, p)){\r\n        if(typeof obj[p] == 'function') continue\r\n        if(p == search){\r\n          results.push(obj[p])\r\n          continue\r\n        }\r\n        if(typeof obj[p] == 'object' && depth < 7){\r\n          this.searchProperty(obj[p], search, results, depth+1)\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  getElements(spec, elements, results = {}) {\r\n\t\telements.map(d => d.split('/')[d.split('/').length-1]).forEach(element => {\r\n\t\t\tresults[element] = spec[element]\r\n\t\t\tlet refs = []\r\n\t\t\tthis.searchProperty(spec[element], '$ref', refs)\r\n\t\t\tif(refs.length > 0) this.getElements(spec, refs, results)\r\n\t\t})\t\t\r\n\t\treturn results\r\n\t}\r\n\r\n  createSecurityRoute(app) {\r\n    let swaggerSpec = swaggerJSDoc(this.options)\r\n\r\n    app.all('*', (req,res,next) => {\r\n      let products = swaggerSpec.paths[req.path] ? swaggerSpec.paths[req.path]['x-access'] : null\r\n      if(products == undefined || this.config.access.some(p => products.includes(p))){\r\n        next()\r\n      }\r\n      else {\r\n        res.send('Bad serial')\r\n      }\r\n    })\r\n  }\r\n\r\n  createSwaggerRoute(app) {\r\n    let swaggerSpecAdmin = this.filterAccess(swaggerJSDoc(this.options))\r\n    app.use('/_', swaggerUi.serve, swaggerUi.setup(swaggerSpecAdmin))\r\n\r\n    let swaggerSpec = this.filterVisibility(swaggerJSDoc(this.options))\r\n    app.use('/', swaggerUi.serve, swaggerUi.setup(swaggerSpec))\r\n  }\r\n}\r\n\r\nmodule.exports = SwaggerModule"],"file":"index.js"}